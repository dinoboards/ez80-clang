name: clang-tool-chain

on:
  push:
    branches:
      - '**'
    tags:
      - '**'

permissions:
  contents: write  # Ensure the GITHUB_TOKEN has write permissions for contents

jobs:
  clang-tool-chain:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Source version.sh and set environment variables
        id: set-env-vars
        run: |
          source ./releases/version.sh
          echo "EZ80_CLANG_TOOLCHAIN_VERSION=$EZ80_CLANG_TOOLCHAIN_VERSION" >> $GITHUB_ENV
          echo "EZ80_CLANG_VERSION=$EZ80_CLANG_VERSION" >> $GITHUB_ENV
          echo "PREVIOUS_EZ80_CLANG_VERSION=$PREVIOUS_EZ80_CLANG_VERSION" >> $GITHUB_ENV
          echo PREVIOUS_EZ80_CLANG_VERSION: $PREVIOUS_EZ80_CLANG_VERSION
          echo EZ80_CLANG_VERSION: $EZ80_CLANG_VERSION

      - name: download llvm for ez80
        run: make download-llvm-release

      - name: compile runtime
        run: make

      - name: package clang and runtime
        run: make package

      - name: Archive
        uses: actions/upload-artifact@v4
        with:
          compression-level: 0
          name: package
          path: ez80-clang-${{ env.EZ80_CLANG_VERSION }}.tar.gz

      - name: Install GitHub CLI
        run: sudo apt-get install -y gh

      - name: Create Draft Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          (cd ./releases && ./create-release-notes.sh)
          (cd ./releases && ./create-draft-release.sh)
